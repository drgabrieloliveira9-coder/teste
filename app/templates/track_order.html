{% extends "base.html" %}
{% block title %}Acompanhar Pedido #{{ order.id }} - {{ site_settings.store_name }}{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f4f7f6;
    }
    .tracking-container {
        padding: 3rem 0;
    }
    .tracking-header {
        text-align: center;
        margin-bottom: 3rem;
    }
    .tracking-header h1 {
        font-size: 2.5rem;
    }
    .tracking-header .order-number {
        font-family: 'Poppins', sans-serif;
        font-weight: 300;
        font-size: 1.5rem;
        color: var(--text-light);
    }
    .tracking-header .order-number strong {
        font-weight: 600;
        color: var(--text-dark);
    }
    
    .timeline {
        display: flex;
        justify-content: space-between;
        position: relative;
        margin-bottom: 3rem;
    }
    .timeline::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 4px;
        background-color: var(--border-color);
        transform: translateY(-50%);
        z-index: 1;
    }
    .timeline-progress {
        position: absolute;
        top: 50%;
        left: 0;
        height: 4px;
        background: var(--primary-color);
        transform: translateY(-50%);
        z-index: 2;
        transition: width 0.5s ease;
    }
    .timeline-step {
        position: relative;
        z-index: 3;
        text-align: center;
    }
    .timeline-step .step-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--white);
        border: 4px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.5rem;
        color: var(--text-light);
        transition: all 0.5s ease;
    }
    .timeline-step .step-label {
        font-weight: 600;
        color: var(--text-light);
        transition: color 0.5s ease;
    }
    
    .timeline-step.completed .step-icon {
        border-color: var(--success);
        color: var(--success);
    }
    .timeline-step.completed .step-label {
        color: var(--text-dark);
    }

    .timeline-step.active .step-icon {
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: scale(1.1);
        box-shadow: 0 0 0 8px rgba(233, 152, 86, 0.2);
    }
    .timeline-step.active .step-label {
        color: var(--primary-color);
    }

    .order-details-card {
        background-color: var(--white);
    }
    .item-row {
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
    }
    .item-row:last-child {
        border-bottom: none;
    }
    .item-status {
        font-size: 0.8rem;
        font-weight: 700;
    }
    .item-status.novo { color: var(--info); }
    .item-status.preparando { color: var(--warning); }
    .item-status.pronto { color: var(--success); }

    .refresh-notice {
        text-align: center;
        color: var(--text-light);
        font-size: 0.9rem;
        margin-top: 2rem;
    }
    .refresh-notice i {
        animation: spin 2s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="tracking-container container">
    <div class="tracking-header">
        <h1>Acompanhe seu Pedido</h1>
        <p class="order-number">Pedido <strong>#{{ order.id }}</strong></p>
    </div>
    
    <div class="card">
        <div class="card-body p-lg-5">
            <div class="timeline">
                <div class="timeline-progress" style="width: {{ progress }}%;"></div>
                <div class="timeline-step {% if order.status in ['pendente', 'preparando', 'pronto', 'entregue', 'finalizado'] %}completed{% endif %} {% if order.status == 'pendente' %}active{% endif %}">
                    <div class="step-icon"><i class="fas fa-receipt"></i></div>
                    <div class="step-label">Recebido</div>
                </div>
                <div class="timeline-step {% if order.status in ['preparando', 'pronto', 'entregue', 'finalizado'] %}completed{% endif %} {% if order.status == 'preparando' %}active{% endif %}">
                    <div class="step-icon"><i class="fas fa-fire-alt"></i></div>
                    <div class="step-label">Preparando</div>
                </div>
                <div class="timeline-step {% if order.status in ['pronto', 'entregue', 'finalizado'] %}completed{% endif %} {% if order.status == 'pronto' %}active{% endif %}">
                    <div class="step-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="step-label">Pronto</div>
                </div>
                <div class="timeline-step {% if order.status in ['entregue', 'finalizado'] %}completed{% endif %}">
                    <div class="step-icon"><i class="fas fa-thumbs-up"></i></div>
                    <div class="step-label">Finalizado</div>
                </div>
            </div>

            <div class="text-center my-5">
                <h2>{{ status_friendly }}</h2>
                {% if estimated_time %}
                <p class="text-muted"><i class="fas fa-clock me-2"></i>Tempo estimado: {{ estimated_time }}</p>
                {% endif %}
            </div>

            <div class="row g-4">
                <div class="col-lg-7">
                    <div class="card order-details-card h-100">
                        <div class="card-body">
                            <h5 class="mb-3">Itens do Pedido</h5>
                            {% for item in items %}
                            <div class="item-row d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="fw-bold">{{ item.quantity }}x</span> {{ item.product_name }}
                                </div>
                                <span class="badge rounded-pill text-bg-light item-status {{ item.status }}">{{ item.status|upper }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="card order-details-card h-100">
                        <div class="card-body">
                            <h5 class="mb-3">Detalhes</h5>
                            <div class="item-row d-flex justify-content-between">
                                <span class="text-muted">Tipo</span>
                                <strong>
                                    {% if order.table_id %} <i class="fas fa-table me-2"></i> Mesa {{ order.table_id }} {% endif %}
                                    {% if order.order_type == 'entrega' %} <i class="fas fa-motorcycle me-2"></i> Entrega {% endif %}
                                    {% if order.order_type == 'retirada' and not order.table_id %} <i class="fas fa-shopping-bag me-2"></i> Retirada {% endif %}
                                </strong>
                            </div>
                             <div class="item-row d-flex justify-content-between">
                                <span class="text-muted">Total</span>
                                <strong class="fs-5 text-primary-emphasis">R$ {{ "%.2f"|format(order.total) }}</strong>
                            </div>
                            {% if order.notes %}
                            <div class="item-row d-flex justify-content-between">
                                <span class="text-muted">Observações</span>
                                <span>{{ order.notes }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    <div class="refresh-notice">
        <i class="fas fa-sync-alt"></i> Esta página é atualizada automaticamente.
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function reloadPage() {
        // Only reload if the order is not in a final state
        const finalStates = ['entregue', 'finalizado', 'cancelado'];
        const currentStatus = '{{ order.status }}';
        if (!finalStates.includes(currentStatus)) {
            setTimeout(() => {
                location.reload();
            }, 10000); // Reload every 10 seconds
        }
    }
    reloadPage();
});
</script>
{% endblock %}
